#include <msp430fr2433.h>
#include <stdio.h>
#include <stdint.h>
#include <string.h>

#include "uart_esp8266_12e.h"
#include "uart_hc06.h"
#include "ssd1306_lib.h"
#include "at_commands_esp.h"
#include "esp8266_12e.h"
//******************************************************************************************************************************************
void openingPage(void);
void serverError(void);

//******************************************************************************************************************************************
extern volatile bool crcError;
extern unsigned char* bluetoothSerialCommand;
extern char* dataPtr;
extern unsigned int index;
extern unsigned char receivedData[400];
extern char espData[400];

//******************************************************************************************************************************************
volatile unsigned int status = 0;
volatile bool wifi = false;
volatile bool connectServer = false;
volatile bool getData = false;
unsigned char reqType[12] = {0x01,0x02,0x03,0x04,0x05,0x06,0x08,0x07,0x09,0x0A,0x0B,'\0'};
char buffT [200] ={0};
char buffW [200] ={0};
char buffS [200] ={0};
char bluetoothData [200] ={0};
char requestWheather [200] ={0};
char requestServer [200] ={0};
char requestTime [200] ={0};
const unsigned char wifi_logo[] = {
                                   0xff, 0xff, 0x03, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb,
                                   0xfb, 0xfb, 0x7b, 0x7b, 0x7b, 0x7b, 0x7b, 0x7b, 0x7b, 0x7b, 0x7b, 0x7b, 0x7b, 0x7b, 0xfb, 0xfb,
                                   0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0xfb, 0x03, 0xff, 0xff,
                                   0xff, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xbf, 0x1f, 0x4f, 0x27, 0x93, 0xcb, 0xe9, 0x65, 0x34,
                                   0x32, 0xba, 0x9a, 0x59, 0x59, 0x4d, 0x4d, 0x0d, 0x0d, 0x4d, 0x4d, 0x59, 0x59, 0x9a, 0xba, 0x32,
                                   0x34, 0x65, 0xe9, 0xcb, 0x93, 0x27, 0x4f, 0x1f, 0xbf, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0xff,
                                   0xff, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfb, 0xf1, 0xf4, 0xf2, 0xf9,
                                   0x9d, 0x0e, 0x26, 0x96, 0xd3, 0xc3, 0xcb, 0xcb, 0xcb, 0xcb, 0xc3, 0xd3, 0x96, 0x26, 0x0e, 0x9d,
                                   0xf9, 0xf2, 0xf4, 0xf1, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0xff,
                                   0xff, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                                   0xff, 0xff, 0xff, 0xff, 0x8f, 0x07, 0x73, 0xfb, 0xfb, 0x73, 0x07, 0xcf, 0xff, 0xff, 0xff, 0xff,
                                   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0xff,
                                   0xff, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xdf, 0x1f, 0xff,
                                   0x7f, 0x9f, 0x1f, 0xff, 0x3f, 0x9f, 0xfe, 0xfe, 0x1e, 0xfe, 0xff, 0x1f, 0x5f, 0x5f, 0x5f, 0xff,
                                   0xff, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0xff,
                                   0xff, 0xff, 0xc0, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xde, 0xd8,
                                   0xdc, 0xdf, 0xde, 0xd8, 0xdc, 0xdf, 0xdf, 0xdf, 0xd8, 0xdf, 0xdf, 0xd8, 0xdf, 0xdf, 0xdf, 0xdf,
                                   0xdf, 0xd8, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xdf, 0xc0, 0xff, 0xff
};

const unsigned char logo[]  = {
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0x0f, 0x07, 0x37, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x0f, 0x0f, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0x3f, 0x3f, 0x7f, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0x0f, 0x3f, 0x7f, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x3f, 0x1f, 0x1f, 0x0f,
                               0x00, 0x00, 0x00, 0x00, 0xb0, 0xb0, 0x36, 0xf6, 0xf6, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00,
                               0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xf8, 0xf0, 0xe0, 0xc1, 0x81, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                               0x00, 0xc0, 0xe0, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfc,
                               0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0xfc, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff,
                               0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xe0, 0xec, 0xfe, 0xff, 0xef, 0xff,
                               0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe,
                               0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe,
                               0xfe, 0xfe, 0xf7, 0xf0, 0xf0, 0xf0, 0xf0, 0xff, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe
                           };
const unsigned char hacettepe_logo[] = {
                                 0x00, 0x00, 0x80, 0xF0, 0x38, 0x0C, 0x0C, 0x84, 0x84, 0xC6,
                                 0xC6, 0xE6, 0x26, 0x16, 0x06, 0x06, 0x04, 0x04, 0x0C, 0x0C,
                                 0x38, 0xF0, 0x80, 0x00, 0x00, 0xC0, 0xFF, 0x07, 0x00, 0x00,
                                 0x00, 0x01, 0xF1, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00,
                                 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0x00, 0x00, 0x3F,
                                 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0xFF, 0x18, 0x0C,
                                 0x0C, 0x0C, 0x0C, 0x18, 0xF8, 0xF0, 0x00, 0x00, 0x00, 0x00,
                                 0xFF, 0x1F, 0x00, 0x00, 0x1F, 0xFE, 0xC0, 0x00, 0x00, 0x00,
                                 0x00, 0x1F, 0x7E, 0x00, 0x00, 0x00, 0x70, 0x7F, 0x07, 0x00,
                                 0x00, 0x00, 0xC0, 0xFE, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x01,
                                 0x01, 0x03, 0x03, 0x02, 0x02, 0x02, 0x06, 0x06, 0x06, 0x06,
                                 0x06, 0x02, 0x02, 0x02, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00
                                 };
//******************************************************************************************************************************************
/**
 * main.c
 */

/**
 * do the clock configuration
 * do the uart configuration for ESP
 * do the uart configuration for BLUETOOTH
 * initialize ESP
 * set the ESP WiFi mode
 * connect to the WiFi
 * connect to the server
 * get data from server
 * parse the data and control the CRC
 * send parsed data to OLED and Bluetooth Application
 *
 *
 * ERRORS:
 * - some times a disconnection issue occures while ESP was trying to connect to the server
 */
int main(void){

    WDTCTL = WDTPW | WDTHOLD;   // stop watchdog timer
    SFRRPCR |= ~SYSNMI | SYSRSTUP;

    // GPIO configurationfor button and Port interrupt
    P1DIR &= ~BIT0;            // P2.3 input
    P1REN |= BIT0;             // pull up enable
    P1OUT |= BIT0;             // pull up
    //Port interrupt config.
    P1IE |= BIT0;               // int. enable
    P1IES |= BIT0;             // int. enable for high to low transition
    P1IFG &= ~BIT0;
    __bis_SR_register(GIE);
    PM5CTL0 &= ~LOCKLPM5;                                      // Disable the GPIO power-on default high-impedance mode

    ssd1306Init();                                             // initialize the OLED
    fillDisplay (0x00);

    espSerialInit();                                          // do UART configuration for ESP8266
    espInit();                                                // initialize the ESP8266
    hc06SerialInit();                                         // do UART configuration for HC-06
    openingPage();											  // welcome function


    volatile unsigned int id_index = 0;
    volatile bool crcErrorTemp = false;

    for(;;){
        wifi = espConnectWifi();
        connectServer = espConnectServer();
        while( wifi && connectServer ){
            unsigned int m = 99;
            for(; m > 0; m--){
                bluetoothData[m] = '\0';
                requestWheather[m] = '\0';
                requestTime[m] = '\0';
                requestServer[m] = '\0';
            }
            bluetoothData[0] = '\0';
            requestWheather[0] = '\0';
            requestTime[0] = '\0';
            requestServer[0] = '\0';

            while( id_index < 11){
                if(espGETData(reqType[id_index])){
                    strcat(bluetoothData, (const char *)dataPtr);
                    strcat(bluetoothData, "|");

                    if(id_index < 6){
                        strcat(requestWheather, (const char *)dataPtr);
                        strcat(requestWheather, "|");
                    }
                    else if((id_index >=6) && (id_index < 8)){
                        strcat(requestTime, (const char *)dataPtr);
                        strcat(requestTime, "|");
                    }
                    else if((id_index >=8) && (id_index < 11)){
                        strcat(requestServer, (const char *)dataPtr);
                        strcat(requestServer, "|");
                    }
                    id_index +=1;
                }
                else{
                    crcErrorTemp = crcError;
                    if(crcErrorTemp){
                        strcat(bluetoothData, "ERROR");
                        strcat(bluetoothData, "|");
                    if(id_index < 6){
                        strcat(requestWheather, "ERROR");
                        strcat(requestWheather, "|");
                    }
                    else if((id_index >=6) && (id_index < 8)){
                        strcat(requestTime, "ERROR");
                        strcat(requestTime, "|");
                    }
                    else if((id_index >=8) && (id_index < 11)){
                        strcat(requestServer, "ERROR");
                        strcat(requestServer, "|");
                    }
                    id_index +=1;
                    }
                    else{
                    id_index = 11;
                    wifi = false;
                    connectServer = false;
                    }
                }
            }
            id_index = 0;
            if(!wifi){
                espSendCommand(AT_ATE0, "OK", 100);
            }
            else{
                bluetoothData[strlen(bluetoothData)-1] = '\n';
                bluetoothData[strlen(bluetoothData)] = '\0';

                requestTime[strlen(requestTime)-1] = '\0';
                requestWheather[strlen(requestWheather)-1] = '\0';
                requestServer[strlen(requestServer)-1] = '\0';
                hc06SerialTxData (bluetoothData);

                fillDisplay (0x00);

                if(status == 0){
                	drawImage(50, 32, 24, 32, hacettepe_logo, 1);
                   displayDataToOled('T', requestTime);
                }
                else if(status == 1){
                	drawImage(104, 25, 24, 35, hacettepe_logo, 1);
                   displayDataToOled('W', requestWheather);
                }
                else if(status == 2){
                	drawImage(104, 25, 24, 35, hacettepe_logo, 1);
                   displayDataToOled('S', requestServer);
                }else{
                	drawImage(104, 25, 24, 35, hacettepe_logo, 1);
                   draw6x8Str(0,6, "id hatali", 1, 0);
                }
            }
        }
        serverError();
    }
}

#pragma vector = PORT1_VECTOR
__interrupt void Port_1 (void){
    if ((P1IES & BIT0) == 0){ // when button unpressed
        P1IES |=  BIT0;
        P1IFG &= ~BIT0;
        if(wifi && connectServer){
            if(status == 0){ status=1;}
            else if(status == 1){ status = 2; }
            else if(status == 2){ status = 0; }
        }
    }
    else{   // when button pressed
        P1IES &= ~BIT0;
        P1IFG &= ~BIT0;
    }
}

void openingPage(void){
	// display project name with logo
	fillDisplay (0x00);
	draw6x8Str(46, 0, "ELE417", 1, 0);
	draw6x8Str(16, 1, "Embedded Systems", 1, 0);
	drawImage(50, 16, 24, 35, hacettepe_logo, 1);
	draw6x8Str(28, 7, "IoT projects", 1, 0);
	int iCount = 20;
	for(; iCount > 0; iCount--){
		__delay_cycles(100000);
	}

	// display group member's names
	fillDisplay (0x00);
	draw6x8Str(28, 0, "Developed By", 1, 0);
	draw6x8Str(0, 2, "Burhan KAPLAN", 1, 0);
	draw6x8Str(0, 3, "Esref DOGAN", 1, 0);
	draw6x8Str(0, 4, "Yalginay YALTIRIK", 1, 0);
	draw6x8Str(0, 5, "Murat CAY", 1, 0);
	iCount = 20;
	for(; iCount > 0; iCount--){
		__delay_cycles(100000);
	}
    
	// server connecting
	fillDisplay (0x00);
	drawImage(40, 16, 48, 48, wifi_logo, 0);
	draw6x8Str(22, 0, "Server Conn...", 1, 0);
}

void serverError(void){
	fillDisplay (0x00);
	drawImage(32, 0, 64, 64, logo, 0);
	draw6x8Str(13, 0, "No Server Conn...", 1, 0);

}
